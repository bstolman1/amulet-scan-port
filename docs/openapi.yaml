openapi: 3.0.3
info:
  title: Amulet Scan API
  description: |
    REST API for querying Canton Network ledger data, governance events, and statistics.
    
    ## Authentication
    Currently no authentication required for read endpoints.
    
    ## Rate Limiting
    No rate limiting enforced in current version.
    
    ## Data Sources
    The API may return data from different sources indicated by `data_source`:
    - `engine` - Real-time warehouse engine
    - `binary` - Binary file storage
    - `jsonl` - JSONL file storage
    - `parquet` - Parquet file storage
    - `empty` - No data available
  version: 1.0.0
  contact:
    name: API Support
  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0

servers:
  - url: http://localhost:3001
    description: Local development server
  - url: https://api.example.com
    description: Production server

tags:
  - name: Health
    description: Health check endpoints
  - name: Events
    description: Ledger event queries
  - name: Stats
    description: Statistics and aggregations
  - name: Governance
    description: Governance lifecycle data
  - name: ACS
    description: Active Contract Set queries
  - name: Party
    description: Party-specific queries
  - name: Search
    description: Cross-entity search

paths:
  /:
    get:
      summary: API Information
      description: Returns API metadata and available endpoints
      operationId: getApiInfo
      tags: [Health]
      responses:
        '200':
          description: API information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiInfo'

  /health:
    get:
      summary: Health Check
      description: Quick health check for load balancers
      operationId: getHealth
      tags: [Health]
      responses:
        '200':
          description: Service healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /health/detailed:
    get:
      summary: Detailed Health Check
      description: Detailed health with engine and cache status
      operationId: getHealthDetailed
      tags: [Health]
      responses:
        '200':
          description: Detailed health status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DetailedHealthResponse'

  /api/events/latest:
    get:
      summary: Get Latest Events
      description: Returns the most recent ledger events with pagination
      operationId: getLatestEvents
      tags: [Events]
      parameters:
        - $ref: '#/components/parameters/LimitParam'
        - $ref: '#/components/parameters/OffsetParam'
      responses:
        '200':
          description: Paginated event list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EventsResponse'
        '400':
          $ref: '#/components/responses/ValidationError'

  /api/events/by-type/{type}:
    get:
      summary: Get Events by Type
      description: Filter events by event type (created, archived, exercised)
      operationId: getEventsByType
      tags: [Events]
      parameters:
        - name: type
          in: path
          required: true
          schema:
            type: string
            enum: [created, archived, exercised]
          description: Event type to filter by
        - $ref: '#/components/parameters/LimitParam'
        - $ref: '#/components/parameters/OffsetParam'
      responses:
        '200':
          description: Filtered event list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EventsResponse'

  /api/events/by-template/{templateId}:
    get:
      summary: Get Events by Template
      description: Filter events by template ID (partial match supported)
      operationId: getEventsByTemplate
      tags: [Events]
      parameters:
        - name: templateId
          in: path
          required: true
          schema:
            type: string
          description: Template ID or partial match (e.g., "Amulet", "VoteRequest")
          examples:
            amulet:
              value: Splice.Amulet:Amulet
            voteRequest:
              value: VoteRequest
        - $ref: '#/components/parameters/LimitParam'
        - $ref: '#/components/parameters/OffsetParam'
      responses:
        '200':
          description: Filtered event list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EventsResponse'

  /api/events/by-date:
    get:
      summary: Get Events by Date Range
      description: Query events within a specific date range
      operationId: getEventsByDate
      tags: [Events]
      parameters:
        - name: start
          in: query
          required: true
          schema:
            type: string
            format: date-time
          description: Start timestamp (ISO 8601)
        - name: end
          in: query
          required: true
          schema:
            type: string
            format: date-time
          description: End timestamp (ISO 8601)
        - $ref: '#/components/parameters/LimitParam'
      responses:
        '200':
          description: Events within date range
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EventsResponse'

  /api/events/count:
    get:
      summary: Get Event Count
      description: Returns total event count with metadata
      operationId: getEventCount
      tags: [Events]
      responses:
        '200':
          description: Event count
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EventCountResponse'

  /api/events/governance:
    get:
      summary: Get Governance Events
      description: Returns governance-related events (VoteRequest, Confirmation, DsoRules)
      operationId: getGovernanceEvents
      tags: [Events]
      parameters:
        - $ref: '#/components/parameters/LimitParam'
        - $ref: '#/components/parameters/OffsetParam'
      responses:
        '200':
          description: Governance events
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EventsResponse'

  /api/events/vote-requests:
    get:
      summary: Get Vote Requests
      description: Query VoteRequest contracts with filtering
      operationId: getVoteRequests
      tags: [Events]
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [pending, accepted, rejected, all]
            default: all
          description: Filter by vote status
        - name: requester
          in: query
          schema:
            type: string
          description: Filter by requester party
        - name: verbose
          in: query
          schema:
            type: boolean
            default: false
          description: Include full payload
        - $ref: '#/components/parameters/LimitParam'
      responses:
        '200':
          description: Vote request list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VoteRequestsResponse'

  /api/events/debug:
    get:
      summary: Debug Information
      description: Returns debug information about the event engine
      operationId: getEventsDebug
      tags: [Events]
      responses:
        '200':
          description: Debug information
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true

  /api/stats/overview:
    get:
      summary: Get Stats Overview
      description: Dashboard overview statistics
      operationId: getStatsOverview
      tags: [Stats]
      responses:
        '200':
          description: Overview statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatsOverviewResponse'

  /api/stats/daily:
    get:
      summary: Get Daily Stats
      description: Daily event counts for trend analysis
      operationId: getStatsDaily
      tags: [Stats]
      parameters:
        - name: days
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 365
            default: 30
          description: Number of days to return
      responses:
        '200':
          description: Daily statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatsDailyResponse'

  /api/stats/by-type:
    get:
      summary: Get Stats by Event Type
      description: Event counts grouped by event type
      operationId: getStatsByType
      tags: [Stats]
      responses:
        '200':
          description: Type breakdown
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatsByTypeResponse'

  /api/stats/by-template:
    get:
      summary: Get Stats by Template
      description: Event counts grouped by template
      operationId: getStatsByTemplate
      tags: [Stats]
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 50
          description: Maximum templates to return
      responses:
        '200':
          description: Template breakdown
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatsByTemplateResponse'

  /api/stats/hourly:
    get:
      summary: Get Hourly Stats
      description: Hourly activity for the last 24 hours
      operationId: getStatsHourly
      tags: [Stats]
      responses:
        '200':
          description: Hourly statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatsHourlyResponse'

  /api/stats/burn:
    get:
      summary: Get Burn Stats
      description: Token burn statistics
      operationId: getStatsBurn
      tags: [Stats]
      responses:
        '200':
          description: Burn statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatsBurnResponse'

  /api/stats/sources:
    get:
      summary: Get Data Sources
      description: Information about available data sources
      operationId: getStatsSources
      tags: [Stats]
      responses:
        '200':
          description: Data source information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatsSourcesResponse'

  /api/governance-lifecycle:
    get:
      summary: Get Governance Lifecycle
      description: Governance proposal lifecycle data
      operationId: getGovernanceLifecycle
      tags: [Governance]
      parameters:
        - $ref: '#/components/parameters/LimitParam'
        - $ref: '#/components/parameters/OffsetParam'
      responses:
        '200':
          description: Governance proposals
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GovernanceLifecycleResponse'

  /api/governance-lifecycle/stats:
    get:
      summary: Get Governance Stats
      description: Governance statistics summary
      operationId: getGovernanceStats
      tags: [Governance]
      responses:
        '200':
          description: Governance statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GovernanceStatsResponse'
        '404':
          $ref: '#/components/responses/NotFound'

  /api/governance-lifecycle/audit/status:
    get:
      summary: Get Audit Status
      description: Audit system status
      operationId: getAuditStatus
      tags: [Governance]
      responses:
        '200':
          description: Audit status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuditStatusResponse'
        '404':
          $ref: '#/components/responses/NotFound'

  /api/acs/latest:
    get:
      summary: Get Latest ACS Snapshot
      description: Returns the latest Active Contract Set snapshot information
      operationId: getAcsLatest
      tags: [ACS]
      responses:
        '200':
          description: Latest snapshot info
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AcsLatestResponse'

  /api/acs/contracts:
    get:
      summary: Get ACS Contracts
      description: Get contracts by template from the latest ACS snapshot
      operationId: getAcsContracts
      tags: [ACS]
      parameters:
        - name: template
          in: query
          required: true
          schema:
            type: string
          description: Template suffix (e.g., "Amulet", "LockedAmulet")
        - name: limit
          in: query
          schema:
            type: integer
            default: 1000
          description: Maximum contracts to return
      responses:
        '200':
          description: Contract list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AcsContractsResponse'

  /api/acs/supply:
    get:
      summary: Get Token Supply
      description: Current token supply from ACS
      operationId: getAcsSupply
      tags: [ACS]
      responses:
        '200':
          description: Supply information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AcsSupplyResponse'

  /api/acs/rich-list:
    get:
      summary: Get Rich List
      description: Top token holders
      operationId: getAcsRichList
      tags: [ACS]
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 100
          description: Maximum holders to return
      responses:
        '200':
          description: Rich list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AcsRichListResponse'

  /api/party/{partyId}:
    get:
      summary: Get Party Events
      description: Get all events for a specific party
      operationId: getPartyEvents
      tags: [Party]
      parameters:
        - name: partyId
          in: path
          required: true
          schema:
            type: string
          description: Full party identifier
        - $ref: '#/components/parameters/LimitParam'
        - name: index
          in: query
          schema:
            type: boolean
            default: true
          description: Use party index if available
      responses:
        '200':
          description: Party events
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EventsResponse'

  /api/party/{partyId}/summary:
    get:
      summary: Get Party Summary
      description: Get party activity summary
      operationId: getPartySummary
      tags: [Party]
      parameters:
        - name: partyId
          in: path
          required: true
          schema:
            type: string
          description: Full party identifier
      responses:
        '200':
          description: Party summary
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PartySummaryResponse'

  /api/party/search:
    get:
      summary: Search Parties
      description: Search parties by prefix
      operationId: searchParties
      tags: [Party]
      parameters:
        - name: q
          in: query
          required: true
          schema:
            type: string
          description: Search query (prefix)
        - $ref: '#/components/parameters/LimitParam'
      responses:
        '200':
          description: Matching parties
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PartySearchResponse'

  /api/search:
    get:
      summary: Global Search
      description: Search across events, contracts, and parties
      operationId: globalSearch
      tags: [Search]
      parameters:
        - name: q
          in: query
          required: true
          schema:
            type: string
          description: Search query
        - name: type
          in: query
          schema:
            type: string
            enum: [event, contract, party]
          description: Filter by entity type
        - $ref: '#/components/parameters/LimitParam'
      responses:
        '200':
          description: Search results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SearchResponse'

components:
  parameters:
    LimitParam:
      name: limit
      in: query
      schema:
        type: integer
        minimum: 1
        maximum: 1000
        default: 100
      description: Maximum number of results to return

    OffsetParam:
      name: offset
      in: query
      schema:
        type: integer
        minimum: 0
        default: 0
      description: Number of results to skip for pagination

  responses:
    ValidationError:
      description: Validation error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: "Validation failed"
            details:
              - path: ["limit"]
                message: "Expected number, received string"

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: "Not found"

  schemas:
    DataSource:
      type: string
      enum: [engine, binary, jsonl, parquet, empty]
      description: Data source identifier

    ApiInfo:
      type: object
      required: [name, version, status]
      properties:
        name:
          type: string
          example: "Amulet Scan DuckDB API"
        version:
          type: string
          example: "1.0.0"
        status:
          type: string
          enum: [ok]
        engine:
          type: string
          enum: [enabled, disabled]
        endpoints:
          type: array
          items:
            type: string
        dataPath:
          type: string

    HealthResponse:
      type: object
      required: [status, timestamp]
      properties:
        status:
          type: string
          enum: [ok]
        timestamp:
          type: string
          format: date-time

    DetailedHealthResponse:
      allOf:
        - $ref: '#/components/schemas/HealthResponse'
        - type: object
          properties:
            engine:
              type: string
            engineStatus:
              type: object
              properties:
                running:
                  type: boolean
                lastCycle:
                  type: string
                  format: date-time
            cache:
              type: object
              properties:
                entries:
                  type: integer

    LedgerEvent:
      type: object
      required: [event_id, event_type, template_id, effective_at]
      properties:
        update_id:
          type: integer
          format: int64
        event_id:
          type: string
        event_type:
          type: string
          enum: [created, archived, exercised]
        contract_id:
          type: string
        template_id:
          type: string
        effective_at:
          type: string
          format: date-time
        signatories:
          type: array
          items:
            type: string
        observers:
          type: array
          items:
            type: string
        payload:
          type: object
          additionalProperties: true
        migration_id:
          type: integer
          format: int64
        synchronizer_id:
          type: string

    EventsResponse:
      type: object
      required: [data, count]
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/LedgerEvent'
        count:
          type: integer
        hasMore:
          type: boolean
        offset:
          type: integer
        source:
          $ref: '#/components/schemas/DataSource'

    EventCountResponse:
      type: object
      required: [count, source]
      properties:
        count:
          type: integer
          format: int64
        estimated:
          type: boolean
        fileCount:
          type: integer
        source:
          $ref: '#/components/schemas/DataSource'

    VoteRequest:
      type: object
      properties:
        contract_id:
          type: string
        action_type:
          type: string
        action_name:
          type: string
        requester:
          type: string
        effective_at:
          type: string
          format: date-time
        expires_at:
          type: string
          format: date-time
        votes:
          type: array
          items:
            type: object
            properties:
              sv:
                type: string
              vote:
                type: string
                enum: [accept, reject]
              reason:
                type: string

    VoteRequestsResponse:
      type: object
      required: [data, count]
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/VoteRequest'
        count:
          type: integer
        indexed:
          type: boolean

    StatsOverviewResponse:
      type: object
      required: [total_events, data_source]
      properties:
        total_events:
          type: integer
          format: int64
        unique_contracts:
          type: integer
        unique_templates:
          type: integer
        earliest_event:
          type: string
          format: date-time
        latest_event:
          type: string
          format: date-time
        data_source:
          $ref: '#/components/schemas/DataSource'

    DailyStats:
      type: object
      properties:
        date:
          type: string
          format: date
        event_count:
          type: integer
        contract_count:
          type: integer

    StatsDailyResponse:
      type: object
      required: [data]
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/DailyStats'

    TypeStats:
      type: object
      properties:
        event_type:
          type: string
        count:
          type: integer

    StatsByTypeResponse:
      type: object
      required: [data]
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/TypeStats'

    TemplateStats:
      type: object
      properties:
        template_id:
          type: string
        event_count:
          type: integer
        contract_count:
          type: integer
        first_seen:
          type: string
          format: date-time
        last_seen:
          type: string
          format: date-time

    StatsByTemplateResponse:
      type: object
      required: [data]
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/TemplateStats'

    HourlyStats:
      type: object
      properties:
        hour:
          type: string
          format: date-time
        event_count:
          type: integer

    StatsHourlyResponse:
      type: object
      required: [data]
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/HourlyStats'

    BurnStats:
      type: object
      properties:
        date:
          type: string
          format: date
        burn_amount:
          type: number
          format: double
        burn_count:
          type: integer

    StatsBurnResponse:
      type: object
      required: [data]
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/BurnStats'

    StatsSourcesResponse:
      type: object
      properties:
        sources:
          type: array
          items:
            type: string
        primary_source:
          $ref: '#/components/schemas/DataSource'

    Proposal:
      type: object
      properties:
        id:
          type: string
        action:
          type: string
        status:
          type: string
          enum: [pending, accepted, rejected, executed, expired]
        created_at:
          type: string
          format: date-time
        votes:
          type: object
          properties:
            accept:
              type: integer
            reject:
              type: integer

    GovernanceLifecycleResponse:
      type: object
      properties:
        proposals:
          type: array
          items:
            $ref: '#/components/schemas/Proposal'
        data:
          type: array
          items:
            $ref: '#/components/schemas/Proposal'
        total:
          type: integer
        count:
          type: integer
        hasMore:
          type: boolean

    GovernanceStatsResponse:
      type: object
      properties:
        total_proposals:
          type: integer
        pending:
          type: integer
        accepted:
          type: integer
        rejected:
          type: integer
        executed:
          type: integer

    AuditStatusResponse:
      type: object
      properties:
        status:
          type: string
        enabled:
          type: boolean

    AcsLatestResponse:
      type: object
      properties:
        snapshot:
          type: object
          properties:
            migrationId:
              type: integer
            snapshotTime:
              type: string
              format: date-time
            isComplete:
              type: boolean
        stats:
          type: object
          properties:
            totalContracts:
              type: integer
            uniqueTemplates:
              type: integer

    AcsContractsResponse:
      type: object
      required: [data, count]
      properties:
        data:
          type: array
          items:
            type: object
            properties:
              contract_id:
                type: string
              template_id:
                type: string
              payload:
                type: object
              created_at:
                type: string
                format: date-time
        count:
          type: integer
        snapshot:
          type: object
          properties:
            migrationId:
              type: integer
            snapshotTime:
              type: string
              format: date-time

    AcsSupplyResponse:
      type: object
      properties:
        total_supply:
          type: number
          format: double
        locked_supply:
          type: number
          format: double
        circulating_supply:
          type: number
          format: double
        snapshot_time:
          type: string
          format: date-time

    AcsRichListResponse:
      type: object
      required: [data]
      properties:
        data:
          type: array
          items:
            type: object
            properties:
              party:
                type: string
              balance:
                type: number
                format: double
              locked:
                type: number
                format: double
              total:
                type: number
                format: double
              rank:
                type: integer

    PartySummaryResponse:
      type: object
      properties:
        party:
          type: string
        event_count:
          type: integer
        first_seen:
          type: string
          format: date-time
        last_seen:
          type: string
          format: date-time
        templates:
          type: array
          items:
            type: string

    PartySearchResponse:
      type: object
      required: [data]
      properties:
        data:
          type: array
          items:
            type: object
            properties:
              party:
                type: string
              event_count:
                type: integer

    SearchResponse:
      type: object
      required: [results]
      properties:
        results:
          type: array
          items:
            type: object
            properties:
              type:
                type: string
                enum: [event, contract, party]
              id:
                type: string
              match:
                type: string
              score:
                type: number
        count:
          type: integer

    ErrorResponse:
      type: object
      required: [error]
      properties:
        error:
          type: string
        message:
          type: string
        details:
          oneOf:
            - type: string
            - type: array
              items:
                $ref: '#/components/schemas/ValidationIssue'

    ValidationIssue:
      type: object
      properties:
        path:
          type: array
          items:
            type: string
        message:
          type: string
        code:
          type: string
