openapi: 3.0.3
info:
  title: Amulet Scan API
  description: |
    REST API for querying Canton Network ledger data, governance events, and statistics.
    
    ## Authentication
    Currently no authentication required for read endpoints.
    
    ## Rate Limiting
    No rate limiting enforced in current version.
    
    ## Data Sources
    The API may return data from different sources indicated by `data_source`:
    - `engine` - Real-time warehouse engine
    - `binary` - Binary file storage
    - `jsonl` - JSONL file storage
    - `parquet` - Parquet file storage
    - `empty` - No data available
  version: 1.0.0
  contact:
    name: API Support
  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0

servers:
  - url: http://localhost:3001
    description: Local development server
  - url: https://api.example.com
    description: Production server

tags:
  - name: Health
    description: Health check endpoints
  - name: Events
    description: Ledger event queries
  - name: Updates
    description: Ledger update queries
  - name: Stats
    description: Statistics and aggregations
  - name: Governance
    description: Governance lifecycle data
  - name: ACS
    description: Active Contract Set queries
  - name: Party
    description: Party-specific queries
  - name: Search
    description: Cross-entity search
  - name: Backfill
    description: Backfill progress and management
  - name: Rewards
    description: Reward calculation and queries
  - name: Contracts
    description: Contract lifecycle queries
  - name: Announcements
    description: SV announcements from Groups.io
  - name: Kaiko
    description: Kaiko market data API
  - name: Engine
    description: Warehouse engine management

paths:
  /:
    get:
      summary: API Information
      description: Returns API metadata and available endpoints
      operationId: getApiInfo
      tags: [Health]
      responses:
        '200':
          description: API information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiInfo'

  /health:
    get:
      summary: Health Check
      description: Quick health check for load balancers
      operationId: getHealth
      tags: [Health]
      responses:
        '200':
          description: Service healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /health/detailed:
    get:
      summary: Detailed Health Check
      description: Detailed health with engine and cache status
      operationId: getHealthDetailed
      tags: [Health]
      responses:
        '200':
          description: Detailed health status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DetailedHealthResponse'

  /api/events/latest:
    get:
      summary: Get Latest Events
      description: Returns the most recent ledger events with pagination
      operationId: getLatestEvents
      tags: [Events]
      parameters:
        - $ref: '#/components/parameters/LimitParam'
        - $ref: '#/components/parameters/OffsetParam'
      responses:
        '200':
          description: Paginated event list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EventsResponse'
        '400':
          $ref: '#/components/responses/ValidationError'

  /api/events/by-type/{type}:
    get:
      summary: Get Events by Type
      description: Filter events by event type (created, archived, exercised)
      operationId: getEventsByType
      tags: [Events]
      parameters:
        - name: type
          in: path
          required: true
          schema:
            type: string
            enum: [created, archived, exercised]
          description: Event type to filter by
        - $ref: '#/components/parameters/LimitParam'
        - $ref: '#/components/parameters/OffsetParam'
      responses:
        '200':
          description: Filtered event list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EventsResponse'

  /api/events/by-template/{templateId}:
    get:
      summary: Get Events by Template
      description: Filter events by template ID (partial match supported)
      operationId: getEventsByTemplate
      tags: [Events]
      parameters:
        - name: templateId
          in: path
          required: true
          schema:
            type: string
          description: Template ID or partial match (e.g., "Amulet", "VoteRequest")
          examples:
            amulet:
              value: Splice.Amulet:Amulet
            voteRequest:
              value: VoteRequest
        - $ref: '#/components/parameters/LimitParam'
        - $ref: '#/components/parameters/OffsetParam'
      responses:
        '200':
          description: Filtered event list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EventsResponse'

  /api/events/by-date:
    get:
      summary: Get Events by Date Range
      description: Query events within a specific date range
      operationId: getEventsByDate
      tags: [Events]
      parameters:
        - name: start
          in: query
          required: true
          schema:
            type: string
            format: date-time
          description: Start timestamp (ISO 8601)
        - name: end
          in: query
          required: true
          schema:
            type: string
            format: date-time
          description: End timestamp (ISO 8601)
        - $ref: '#/components/parameters/LimitParam'
      responses:
        '200':
          description: Events within date range
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EventsResponse'

  /api/events/count:
    get:
      summary: Get Event Count
      description: Returns total event count with metadata
      operationId: getEventCount
      tags: [Events]
      responses:
        '200':
          description: Event count
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EventCountResponse'

  /api/events/governance:
    get:
      summary: Get Governance Events
      description: Returns governance-related events (VoteRequest, Confirmation, DsoRules)
      operationId: getGovernanceEvents
      tags: [Events]
      parameters:
        - $ref: '#/components/parameters/LimitParam'
        - $ref: '#/components/parameters/OffsetParam'
      responses:
        '200':
          description: Governance events
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EventsResponse'

  /api/events/vote-requests:
    get:
      summary: Get Vote Requests
      description: Query VoteRequest contracts with filtering
      operationId: getVoteRequests
      tags: [Events]
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [pending, accepted, rejected, all]
            default: all
          description: Filter by vote status
        - name: requester
          in: query
          schema:
            type: string
          description: Filter by requester party
        - name: verbose
          in: query
          schema:
            type: boolean
            default: false
          description: Include full payload
        - $ref: '#/components/parameters/LimitParam'
      responses:
        '200':
          description: Vote request list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VoteRequestsResponse'

  /api/events/debug:
    get:
      summary: Debug Information
      description: Returns debug information about the event engine
      operationId: getEventsDebug
      tags: [Events]
      responses:
        '200':
          description: Debug information
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true

  /api/stats/overview:
    get:
      summary: Get Stats Overview
      description: Dashboard overview statistics
      operationId: getStatsOverview
      tags: [Stats]
      responses:
        '200':
          description: Overview statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatsOverviewResponse'

  /api/stats/daily:
    get:
      summary: Get Daily Stats
      description: Daily event counts for trend analysis
      operationId: getStatsDaily
      tags: [Stats]
      parameters:
        - name: days
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 365
            default: 30
          description: Number of days to return
      responses:
        '200':
          description: Daily statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatsDailyResponse'

  /api/stats/by-type:
    get:
      summary: Get Stats by Event Type
      description: Event counts grouped by event type
      operationId: getStatsByType
      tags: [Stats]
      responses:
        '200':
          description: Type breakdown
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatsByTypeResponse'

  /api/stats/by-template:
    get:
      summary: Get Stats by Template
      description: Event counts grouped by template
      operationId: getStatsByTemplate
      tags: [Stats]
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 50
          description: Maximum templates to return
      responses:
        '200':
          description: Template breakdown
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatsByTemplateResponse'

  /api/stats/hourly:
    get:
      summary: Get Hourly Stats
      description: Hourly activity for the last 24 hours
      operationId: getStatsHourly
      tags: [Stats]
      responses:
        '200':
          description: Hourly statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatsHourlyResponse'

  /api/stats/burn:
    get:
      summary: Get Burn Stats
      description: Token burn statistics
      operationId: getStatsBurn
      tags: [Stats]
      responses:
        '200':
          description: Burn statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatsBurnResponse'

  /api/stats/sources:
    get:
      summary: Get Data Sources
      description: Information about available data sources
      operationId: getStatsSources
      tags: [Stats]
      responses:
        '200':
          description: Data source information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatsSourcesResponse'

  /api/governance-lifecycle:
    get:
      summary: Get Governance Lifecycle
      description: Governance proposal lifecycle data
      operationId: getGovernanceLifecycle
      tags: [Governance]
      parameters:
        - $ref: '#/components/parameters/LimitParam'
        - $ref: '#/components/parameters/OffsetParam'
      responses:
        '200':
          description: Governance proposals
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GovernanceLifecycleResponse'

  /api/governance-lifecycle/stats:
    get:
      summary: Get Governance Stats
      description: Governance statistics summary
      operationId: getGovernanceStats
      tags: [Governance]
      responses:
        '200':
          description: Governance statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GovernanceStatsResponse'
        '404':
          $ref: '#/components/responses/NotFound'

  /api/governance-lifecycle/audit/status:
    get:
      summary: Get Audit Status
      description: Audit system status
      operationId: getAuditStatus
      tags: [Governance]
      responses:
        '200':
          description: Audit status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuditStatusResponse'
        '404':
          $ref: '#/components/responses/NotFound'

  /api/acs/latest:
    get:
      summary: Get Latest ACS Snapshot
      description: Returns the latest Active Contract Set snapshot information
      operationId: getAcsLatest
      tags: [ACS]
      responses:
        '200':
          description: Latest snapshot info
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AcsLatestResponse'

  /api/acs/contracts:
    get:
      summary: Get ACS Contracts
      description: Get contracts by template from the latest ACS snapshot
      operationId: getAcsContracts
      tags: [ACS]
      parameters:
        - name: template
          in: query
          required: true
          schema:
            type: string
          description: Template suffix (e.g., "Amulet", "LockedAmulet")
        - name: limit
          in: query
          schema:
            type: integer
            default: 1000
          description: Maximum contracts to return
      responses:
        '200':
          description: Contract list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AcsContractsResponse'

  /api/acs/supply:
    get:
      summary: Get Token Supply
      description: Current token supply from ACS
      operationId: getAcsSupply
      tags: [ACS]
      responses:
        '200':
          description: Supply information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AcsSupplyResponse'

  /api/acs/rich-list:
    get:
      summary: Get Rich List
      description: Top token holders
      operationId: getAcsRichList
      tags: [ACS]
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 100
          description: Maximum holders to return
      responses:
        '200':
          description: Rich list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AcsRichListResponse'

  /api/party/{partyId}:
    get:
      summary: Get Party Events
      description: Get all events for a specific party
      operationId: getPartyEvents
      tags: [Party]
      parameters:
        - name: partyId
          in: path
          required: true
          schema:
            type: string
          description: Full party identifier
        - $ref: '#/components/parameters/LimitParam'
        - name: index
          in: query
          schema:
            type: boolean
            default: true
          description: Use party index if available
      responses:
        '200':
          description: Party events
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EventsResponse'

  /api/party/{partyId}/summary:
    get:
      summary: Get Party Summary
      description: Get party activity summary
      operationId: getPartySummary
      tags: [Party]
      parameters:
        - name: partyId
          in: path
          required: true
          schema:
            type: string
          description: Full party identifier
      responses:
        '200':
          description: Party summary
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PartySummaryResponse'

  /api/party/search:
    get:
      summary: Search Parties
      description: Search parties by prefix
      operationId: searchParties
      tags: [Party]
      parameters:
        - name: q
          in: query
          required: true
          schema:
            type: string
          description: Search query (prefix)
        - $ref: '#/components/parameters/LimitParam'
      responses:
        '200':
          description: Matching parties
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PartySearchResponse'

  /api/search:
    get:
      summary: Global Search
      description: Search across events, contracts, and parties
      operationId: globalSearch
      tags: [Search]
      parameters:
        - name: q
          in: query
          required: true
          schema:
            type: string
          description: Search query
        - name: type
          in: query
          schema:
            type: string
            enum: [event, contract, party]
          description: Filter by entity type
        - $ref: '#/components/parameters/LimitParam'
      responses:
        '200':
          description: Search results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SearchResponse'

  # Updates API
  /api/updates/latest:
    get:
      summary: Get Latest Updates
      description: Returns the most recent ledger updates with pagination
      operationId: getLatestUpdates
      tags: [Updates]
      parameters:
        - $ref: '#/components/parameters/LimitParam'
        - $ref: '#/components/parameters/OffsetParam'
      responses:
        '200':
          description: Paginated update list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UpdatesResponse'

  /api/updates/count:
    get:
      summary: Get Update Count
      description: Returns total update count with source metadata
      operationId: getUpdateCount
      tags: [Updates]
      responses:
        '200':
          description: Update count
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UpdateCountResponse'

  # Backfill API
  /api/backfill/cursors:
    get:
      summary: Get Backfill Cursors
      description: Get all backfill cursor positions
      operationId: getBackfillCursors
      tags: [Backfill]
      responses:
        '200':
          description: Cursor list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BackfillCursorsResponse'

  /api/backfill/stats:
    get:
      summary: Get Backfill Stats
      description: Get backfill statistics from data files
      operationId: getBackfillStats
      tags: [Backfill]
      responses:
        '200':
          description: Backfill statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BackfillStatsResponse'

  /api/backfill/shards:
    get:
      summary: Get Shard Progress
      description: Get shard progress data for parallel backfill operations
      operationId: getBackfillShards
      tags: [Backfill]
      responses:
        '200':
          description: Shard progress data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BackfillShardsResponse'

  /api/backfill/gaps:
    get:
      summary: Get Detected Gaps
      description: Get detected time gaps in the data
      operationId: getBackfillGaps
      tags: [Backfill]
      responses:
        '200':
          description: Gap detection results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BackfillGapsResponse'

  /api/backfill/write-activity:
    get:
      summary: Get Write Activity
      description: Check if files are actively being written
      operationId: getBackfillWriteActivity
      tags: [Backfill]
      responses:
        '200':
          description: Write activity status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BackfillWriteActivityResponse'

  /api/backfill/debug:
    get:
      summary: Debug Backfill
      description: Debug endpoint to check paths and file counts
      operationId: debugBackfill
      tags: [Backfill]
      responses:
        '200':
          description: Debug information
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true

  /api/backfill/purge:
    delete:
      summary: Purge Backfill Data
      description: Purge all backfill data (local files)
      operationId: purgeBackfill
      tags: [Backfill]
      responses:
        '200':
          description: Purge result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BackfillPurgeResponse'

  # Rewards API
  /api/rewards/calculate:
    get:
      summary: Calculate Rewards
      description: Calculate app rewards for a specific party ID within a date or round range
      operationId: calculateRewards
      tags: [Rewards]
      parameters:
        - name: partyId
          in: query
          required: true
          schema:
            type: string
          description: The party ID to calculate rewards for
        - name: startDate
          in: query
          schema:
            type: string
            format: date-time
          description: Start of date range (ISO 8601)
        - name: endDate
          in: query
          schema:
            type: string
            format: date-time
          description: End of date range (ISO 8601)
        - name: startRound
          in: query
          schema:
            type: integer
          description: Start round number
        - name: endRound
          in: query
          schema:
            type: integer
          description: End round number
      responses:
        '200':
          description: Reward calculation result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RewardsCalculateResponse'
        '400':
          $ref: '#/components/responses/ValidationError'

  /api/rewards/templates:
    get:
      summary: List Reward Templates
      description: List available reward templates for reference
      operationId: getRewardTemplates
      tags: [Rewards]
      responses:
        '200':
          description: Reward templates
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RewardTemplatesResponse'

  # Contracts API
  /api/contracts/{contractId}:
    get:
      summary: Get Contract Lifecycle
      description: Get the full lifecycle of a specific contract
      operationId: getContractLifecycle
      tags: [Contracts]
      parameters:
        - name: contractId
          in: path
          required: true
          schema:
            type: string
          description: Contract ID
      responses:
        '200':
          description: Contract lifecycle events
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ContractLifecycleResponse'

  /api/contracts/active/by-template/{templateSuffix}:
    get:
      summary: Get Active Contracts by Template
      description: Get active contracts (created but not archived) by template suffix
      operationId: getActiveContractsByTemplate
      tags: [Contracts]
      parameters:
        - name: templateSuffix
          in: path
          required: true
          schema:
            type: string
          description: Template suffix (e.g., "Amulet", "VoteRequest")
        - $ref: '#/components/parameters/LimitParam'
      responses:
        '200':
          description: Active contracts
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ActiveContractsResponse'

  /api/contracts/templates/list:
    get:
      summary: List Contract Templates
      description: List all unique templates with event and contract counts
      operationId: listContractTemplates
      tags: [Contracts]
      responses:
        '200':
          description: Template list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ContractTemplatesResponse'

  # Announcements API
  /api/announcements:
    get:
      summary: Get Announcements
      description: Fetch announcements from Groups.io supervalidator-announce
      operationId: getAnnouncements
      tags: [Announcements]
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 200
          description: Maximum announcements to return
      responses:
        '200':
          description: Announcements list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AnnouncementsResponse'

  # Kaiko API
  /api/kaiko/ohlcv:
    get:
      summary: Get OHLCV Data
      description: Fetches OHLCV + VWAP data from Kaiko API
      operationId: getKaikoOhlcv
      tags: [Kaiko]
      parameters:
        - name: exchange
          in: query
          schema:
            type: string
            default: cbse
          description: Exchange code (e.g., cbse, krkn, binc)
        - name: instrument_class
          in: query
          schema:
            type: string
            default: spot
            enum: [spot, perpetual-future]
          description: Instrument class
        - name: instrument
          in: query
          schema:
            type: string
            default: btc-usd
          description: Trading pair (e.g., btc-usd, cc-usd)
        - name: interval
          in: query
          schema:
            type: string
            default: 1h
            enum: [1m, 5m, 15m, 1h, 4h, 1d]
          description: Time interval
        - name: start_time
          in: query
          schema:
            type: string
            format: date-time
          description: Start time (ISO 8601)
        - name: end_time
          in: query
          schema:
            type: string
            format: date-time
          description: End time (ISO 8601)
        - name: sort
          in: query
          schema:
            type: string
            default: desc
            enum: [asc, desc]
          description: Sort order
        - name: page_size
          in: query
          schema:
            type: integer
            default: 100
          description: Number of results
      responses:
        '200':
          description: OHLCV data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/KaikoOhlcvResponse'

  /api/kaiko/asset-metrics:
    get:
      summary: Get Asset Metrics
      description: Fetches asset metrics data from Kaiko API (volumes, trades, liquidity, supply)
      operationId: getKaikoAssetMetrics
      tags: [Kaiko]
      parameters:
        - name: asset
          in: query
          schema:
            type: string
            default: btc
          description: Asset code (e.g., btc, eth, sol, cc)
        - name: start_time
          in: query
          schema:
            type: string
            format: date-time
          description: Start time (ISO 8601)
        - name: end_time
          in: query
          schema:
            type: string
            format: date-time
          description: End time (ISO 8601)
        - name: interval
          in: query
          schema:
            type: string
            default: 1h
          description: Time interval
        - name: sources
          in: query
          schema:
            type: string
            default: 'true'
          description: Include exchange breakdown
        - name: page_size
          in: query
          schema:
            type: integer
            default: 100
          description: Number of results
      responses:
        '200':
          description: Asset metrics data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/KaikoAssetMetricsResponse'

  /api/kaiko/cc-market-overview:
    get:
      summary: Get CC Market Overview
      description: Fetches aggregated CC market data across all exchanges
      operationId: getCcMarketOverview
      tags: [Kaiko]
      responses:
        '200':
          description: CC market overview
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/KaikoCcMarketOverviewResponse'

  /api/kaiko/status:
    get:
      summary: Get Kaiko API Status
      description: Check if Kaiko API is configured
      operationId: getKaikoStatus
      tags: [Kaiko]
      responses:
        '200':
          description: Kaiko API status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/KaikoStatusResponse'

  # Engine API
  /api/engine/status:
    get:
      summary: Get Engine Status
      description: Get warehouse engine status
      operationId: getEngineStatus
      tags: [Engine]
      responses:
        '200':
          description: Engine status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EngineStatusResponse'

  /api/engine/stats:
    get:
      summary: Get Engine Stats
      description: Get engine statistics
      operationId: getEngineStats
      tags: [Engine]
      responses:
        '200':
          description: Engine statistics
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true

  /api/engine/cycle:
    post:
      summary: Trigger Engine Cycle
      description: Trigger an engine processing cycle
      operationId: triggerEngineCycle
      tags: [Engine]
      responses:
        '200':
          description: Cycle triggered
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string

  /api/engine/template-index/status:
    get:
      summary: Get Template Index Status
      description: Get template file index status
      operationId: getTemplateIndexStatus
      tags: [Engine]
      responses:
        '200':
          description: Template index status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TemplateIndexStatusResponse'

  /api/engine/template-index/build:
    post:
      summary: Build Template Index
      description: Build or rebuild template file index
      operationId: buildTemplateIndex
      tags: [Engine]
      responses:
        '200':
          description: Build started
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string

components:
  parameters:
    LimitParam:
      name: limit
      in: query
      schema:
        type: integer
        minimum: 1
        maximum: 1000
        default: 100
      description: Maximum number of results to return

    OffsetParam:
      name: offset
      in: query
      schema:
        type: integer
        minimum: 0
        default: 0
      description: Number of results to skip for pagination

  responses:
    ValidationError:
      description: Validation error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: "Validation failed"
            details:
              - path: ["limit"]
                message: "Expected number, received string"

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: "Not found"

  schemas:
    DataSource:
      type: string
      enum: [engine, binary, jsonl, parquet, empty]
      description: Data source identifier

    ApiInfo:
      type: object
      required: [name, version, status]
      properties:
        name:
          type: string
          example: "Amulet Scan DuckDB API"
        version:
          type: string
          example: "1.0.0"
        status:
          type: string
          enum: [ok]
        engine:
          type: string
          enum: [enabled, disabled]
        endpoints:
          type: array
          items:
            type: string
        dataPath:
          type: string

    HealthResponse:
      type: object
      required: [status, timestamp]
      properties:
        status:
          type: string
          enum: [ok]
        timestamp:
          type: string
          format: date-time

    DetailedHealthResponse:
      allOf:
        - $ref: '#/components/schemas/HealthResponse'
        - type: object
          properties:
            engine:
              type: string
            engineStatus:
              type: object
              properties:
                running:
                  type: boolean
                lastCycle:
                  type: string
                  format: date-time
            cache:
              type: object
              properties:
                entries:
                  type: integer

    LedgerEvent:
      type: object
      required: [event_id, event_type, template_id, effective_at]
      properties:
        update_id:
          type: integer
          format: int64
        event_id:
          type: string
        event_type:
          type: string
          enum: [created, archived, exercised]
        contract_id:
          type: string
        template_id:
          type: string
        effective_at:
          type: string
          format: date-time
        signatories:
          type: array
          items:
            type: string
        observers:
          type: array
          items:
            type: string
        payload:
          type: object
          additionalProperties: true
        migration_id:
          type: integer
          format: int64
        synchronizer_id:
          type: string

    EventsResponse:
      type: object
      required: [data, count]
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/LedgerEvent'
        count:
          type: integer
        hasMore:
          type: boolean
        offset:
          type: integer
        source:
          $ref: '#/components/schemas/DataSource'

    EventCountResponse:
      type: object
      required: [count, source]
      properties:
        count:
          type: integer
          format: int64
        estimated:
          type: boolean
        fileCount:
          type: integer
        source:
          $ref: '#/components/schemas/DataSource'

    VoteRequest:
      type: object
      properties:
        contract_id:
          type: string
        action_type:
          type: string
        action_name:
          type: string
        requester:
          type: string
        effective_at:
          type: string
          format: date-time
        expires_at:
          type: string
          format: date-time
        votes:
          type: array
          items:
            type: object
            properties:
              sv:
                type: string
              vote:
                type: string
                enum: [accept, reject]
              reason:
                type: string

    VoteRequestsResponse:
      type: object
      required: [data, count]
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/VoteRequest'
        count:
          type: integer
        indexed:
          type: boolean

    StatsOverviewResponse:
      type: object
      required: [total_events, data_source]
      properties:
        total_events:
          type: integer
          format: int64
        unique_contracts:
          type: integer
        unique_templates:
          type: integer
        earliest_event:
          type: string
          format: date-time
        latest_event:
          type: string
          format: date-time
        data_source:
          $ref: '#/components/schemas/DataSource'

    DailyStats:
      type: object
      properties:
        date:
          type: string
          format: date
        event_count:
          type: integer
        contract_count:
          type: integer

    StatsDailyResponse:
      type: object
      required: [data]
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/DailyStats'

    TypeStats:
      type: object
      properties:
        event_type:
          type: string
        count:
          type: integer

    StatsByTypeResponse:
      type: object
      required: [data]
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/TypeStats'

    TemplateStats:
      type: object
      properties:
        template_id:
          type: string
        event_count:
          type: integer
        contract_count:
          type: integer
        first_seen:
          type: string
          format: date-time
        last_seen:
          type: string
          format: date-time

    StatsByTemplateResponse:
      type: object
      required: [data]
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/TemplateStats'

    HourlyStats:
      type: object
      properties:
        hour:
          type: string
          format: date-time
        event_count:
          type: integer

    StatsHourlyResponse:
      type: object
      required: [data]
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/HourlyStats'

    BurnStats:
      type: object
      properties:
        date:
          type: string
          format: date
        burn_amount:
          type: number
          format: double
        burn_count:
          type: integer

    StatsBurnResponse:
      type: object
      required: [data]
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/BurnStats'

    StatsSourcesResponse:
      type: object
      properties:
        sources:
          type: array
          items:
            type: string
        primary_source:
          $ref: '#/components/schemas/DataSource'

    Proposal:
      type: object
      properties:
        id:
          type: string
        action:
          type: string
        status:
          type: string
          enum: [pending, accepted, rejected, executed, expired]
        created_at:
          type: string
          format: date-time
        votes:
          type: object
          properties:
            accept:
              type: integer
            reject:
              type: integer

    GovernanceLifecycleResponse:
      type: object
      properties:
        proposals:
          type: array
          items:
            $ref: '#/components/schemas/Proposal'
        data:
          type: array
          items:
            $ref: '#/components/schemas/Proposal'
        total:
          type: integer
        count:
          type: integer
        hasMore:
          type: boolean

    GovernanceStatsResponse:
      type: object
      properties:
        total_proposals:
          type: integer
        pending:
          type: integer
        accepted:
          type: integer
        rejected:
          type: integer
        executed:
          type: integer

    AuditStatusResponse:
      type: object
      properties:
        status:
          type: string
        enabled:
          type: boolean

    AcsLatestResponse:
      type: object
      properties:
        snapshot:
          type: object
          properties:
            migrationId:
              type: integer
            snapshotTime:
              type: string
              format: date-time
            isComplete:
              type: boolean
        stats:
          type: object
          properties:
            totalContracts:
              type: integer
            uniqueTemplates:
              type: integer

    AcsContractsResponse:
      type: object
      required: [data, count]
      properties:
        data:
          type: array
          items:
            type: object
            properties:
              contract_id:
                type: string
              template_id:
                type: string
              payload:
                type: object
              created_at:
                type: string
                format: date-time
        count:
          type: integer
        snapshot:
          type: object
          properties:
            migrationId:
              type: integer
            snapshotTime:
              type: string
              format: date-time

    AcsSupplyResponse:
      type: object
      properties:
        total_supply:
          type: number
          format: double
        locked_supply:
          type: number
          format: double
        circulating_supply:
          type: number
          format: double
        snapshot_time:
          type: string
          format: date-time

    AcsRichListResponse:
      type: object
      required: [data]
      properties:
        data:
          type: array
          items:
            type: object
            properties:
              party:
                type: string
              balance:
                type: number
                format: double
              locked:
                type: number
                format: double
              total:
                type: number
                format: double
              rank:
                type: integer

    PartySummaryResponse:
      type: object
      properties:
        party:
          type: string
        event_count:
          type: integer
        first_seen:
          type: string
          format: date-time
        last_seen:
          type: string
          format: date-time
        templates:
          type: array
          items:
            type: string

    PartySearchResponse:
      type: object
      required: [data]
      properties:
        data:
          type: array
          items:
            type: object
            properties:
              party:
                type: string
              event_count:
                type: integer

    SearchResponse:
      type: object
      required: [results]
      properties:
        results:
          type: array
          items:
            type: object
            properties:
              type:
                type: string
                enum: [event, contract, party]
              id:
                type: string
              match:
                type: string
              score:
                type: number
        count:
          type: integer

    ErrorResponse:
      type: object
      required: [error]
      properties:
        error:
          type: string
        message:
          type: string
        details:
          oneOf:
            - type: string
            - type: array
              items:
                $ref: '#/components/schemas/ValidationIssue'

    ValidationIssue:
      type: object
      properties:
        path:
          type: array
          items:
            type: string
        message:
          type: string
        code:
          type: string

    # Updates API Schemas
    UpdatesResponse:
      type: object
      required: [data, count]
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/LedgerEvent'
        count:
          type: integer
        hasMore:
          type: boolean
        source:
          $ref: '#/components/schemas/DataSource'

    UpdateCountResponse:
      type: object
      required: [count]
      properties:
        count:
          type: integer
          format: int64
        estimated:
          type: boolean
        fileCount:
          type: integer
        source:
          $ref: '#/components/schemas/DataSource'

    # Backfill API Schemas
    BackfillCursor:
      type: object
      properties:
        id:
          type: string
        cursor_name:
          type: string
        migration_id:
          type: integer
        synchronizer_id:
          type: string
        min_time:
          type: string
          format: date-time
        max_time:
          type: string
          format: date-time
        last_before:
          type: string
          format: date-time
        complete:
          type: boolean
        last_processed_round:
          type: integer
        updated_at:
          type: string
          format: date-time
        started_at:
          type: string
          format: date-time
        total_updates:
          type: integer
        total_events:
          type: integer
        pending_writes:
          type: integer
        buffered_records:
          type: integer
        is_recently_updated:
          type: boolean
        error:
          type: string

    BackfillCursorsResponse:
      type: object
      required: [data, count]
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/BackfillCursor'
        count:
          type: integer

    BackfillStatsResponse:
      type: object
      properties:
        totalUpdates:
          type: integer
          format: int64
        totalEvents:
          type: integer
          format: int64
        activeMigrations:
          type: integer
        migrationsFromDirs:
          type: array
          items:
            type: integer
        totalCursors:
          type: integer
        completedCursors:
          type: integer
        rawFileCounts:
          type: object
          properties:
            events:
              type: integer
            updates:
              type: integer
            format:
              type: string
              enum: [parquet, pb.zst, none]
            parquetEvents:
              type: integer
            parquetUpdates:
              type: integer
            binaryEvents:
              type: integer
            binaryUpdates:
              type: integer

    BackfillShard:
      type: object
      properties:
        shardIndex:
          type: integer
        isSharded:
          type: boolean
        progress:
          type: number
          format: double
        throughput:
          type: integer
        eta:
          type: integer
          description: Estimated time remaining in milliseconds
        complete:
          type: boolean
        totalUpdates:
          type: integer
        totalEvents:
          type: integer
        pendingWrites:
          type: integer
        bufferedRecords:
          type: integer
        minTime:
          type: string
          format: date-time
        maxTime:
          type: string
          format: date-time
        lastBefore:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        startedAt:
          type: string
          format: date-time
        error:
          type: string

    BackfillShardGroup:
      type: object
      properties:
        migrationId:
          type: integer
        synchronizerId:
          type: string
        shards:
          type: array
          items:
            $ref: '#/components/schemas/BackfillShard'
        totalUpdates:
          type: integer
        totalEvents:
          type: integer
        totalShards:
          type: integer
        completedShards:
          type: integer
        activeShards:
          type: integer
        overallProgress:
          type: number
          format: double
        combinedEta:
          type: integer

    BackfillShardsResponse:
      type: object
      required: [data, count]
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/BackfillShardGroup'
        count:
          type: integer

    BackfillGap:
      type: object
      properties:
        start:
          type: string
          format: date-time
        end:
          type: string
          format: date-time
        duration:
          type: string
        migrationId:
          type: integer

    BackfillGapsResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/BackfillGap'
        totalGaps:
          type: integer
        totalGapTime:
          type: string

    BackfillWriteActivityResponse:
      type: object
      properties:
        isWriting:
          type: boolean
        currentCounts:
          type: object
          properties:
            events:
              type: integer
            updates:
              type: integer
        delta:
          type: object
          properties:
            events:
              type: integer
            updates:
              type: integer
            seconds:
              type: integer
        message:
          type: string

    BackfillPurgeResponse:
      type: object
      properties:
        success:
          type: boolean
        deleted_cursors:
          type: integer
        deleted_data_dir:
          type: boolean

    # Rewards API Schemas
    RewardEvent:
      type: object
      properties:
        event_id:
          type: string
        round:
          type: integer
        amount:
          type: number
          format: double
        weight:
          type: number
          format: double
        effective_at:
          type: string
          format: date-time
        template_id:
          type: string
        templateType:
          type: string

    RewardsByRound:
      type: object
      additionalProperties:
        type: object
        properties:
          count:
            type: integer
          amount:
            type: number
            format: double
          weight:
            type: number
            format: double

    RewardsCalculateResponse:
      type: object
      properties:
        partyId:
          type: string
        totalRewards:
          type: number
          format: double
        totalWeight:
          type: number
          format: double
        rewardCount:
          type: integer
        byRound:
          $ref: '#/components/schemas/RewardsByRound'
        events:
          type: array
          items:
            $ref: '#/components/schemas/RewardEvent'
        queryTime:
          type: number
          format: double
        hasIssuanceData:
          type: boolean
        note:
          type: string

    RewardTemplate:
      type: object
      properties:
        name:
          type: string
        description:
          type: string

    RewardTemplatesResponse:
      type: object
      properties:
        templates:
          type: array
          items:
            $ref: '#/components/schemas/RewardTemplate'

    # Contracts API Schemas
    ContractLifecycleResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/LedgerEvent'
        contract_id:
          type: string

    ActiveContractsResponse:
      type: object
      required: [data, count]
      properties:
        data:
          type: array
          items:
            type: object
            properties:
              contract_id:
                type: string
              template_id:
                type: string
              created_at:
                type: string
                format: date-time
              payload:
                type: object
        count:
          type: integer

    ContractTemplate:
      type: object
      properties:
        template_id:
          type: string
        event_count:
          type: integer
        contract_count:
          type: integer

    ContractTemplatesResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/ContractTemplate'

    # Announcements API Schemas
    Announcement:
      type: object
      properties:
        id:
          type: string
        subject:
          type: string
        date:
          type: string
          format: date-time
        content:
          type: string
        excerpt:
          type: string
        sourceUrl:
          type: string
          format: uri
        linkedUrls:
          type: array
          items:
            type: string
            format: uri
        messageCount:
          type: integer
        hashtags:
          type: array
          items:
            type: string

    AnnouncementsResponse:
      type: object
      properties:
        announcements:
          type: array
          items:
            $ref: '#/components/schemas/Announcement'
        source:
          type: string
        total:
          type: integer
        groupId:
          type: integer

    # Kaiko API Schemas
    KaikoCandle:
      type: object
      properties:
        timestamp:
          type: string
          format: date-time
        open:
          type: string
        high:
          type: string
        low:
          type: string
        close:
          type: string
        volume:
          type: string
        count:
          type: integer
        price:
          type: string
          description: VWAP

    KaikoOhlcvResponse:
      type: object
      properties:
        result:
          type: string
        data:
          type: array
          items:
            $ref: '#/components/schemas/KaikoCandle'
        query:
          type: object
        time:
          type: string

    KaikoAssetMetricsResponse:
      type: object
      properties:
        result:
          type: string
        data:
          type: array
          items:
            type: object
            additionalProperties: true
        query:
          type: object

    KaikoExchangeData:
      type: object
      properties:
        exchange:
          type: string
        exchangeName:
          type: string
        instrument:
          type: string
        instrumentClass:
          type: string
        price:
          type: number
          format: double
        open:
          type: number
          format: double
        high:
          type: number
          format: double
        low:
          type: number
          format: double
        close:
          type: number
          format: double
        volume:
          type: number
          format: double
        vwap:
          type: number
          format: double
        tradeCount:
          type: integer
        previousClose:
          type: number
          format: double
        change24h:
          type: number
          format: double

    KaikoCcMarketOverviewResponse:
      type: object
      properties:
        result:
          type: string
        timestamp:
          type: string
          format: date-time
        summary:
          type: object
          properties:
            price:
              type: number
              format: double
            change24h:
              type: number
              format: double
            vwap:
              type: number
              format: double
            totalVolume:
              type: number
              format: double
            totalTrades:
              type: integer
            activeExchanges:
              type: integer
        exchanges:
          type: array
          items:
            $ref: '#/components/schemas/KaikoExchangeData'

    KaikoStatusResponse:
      type: object
      properties:
        configured:
          type: boolean
        message:
          type: string

    # Engine API Schemas
    EngineStatusResponse:
      type: object
      properties:
        running:
          type: boolean
        lastCycle:
          type: string
          format: date-time
        filesIndexed:
          type: integer
        pendingFiles:
          type: integer

    TemplateIndexStatusResponse:
      type: object
      properties:
        populated:
          type: boolean
        templateCount:
          type: integer
        fileCount:
          type: integer
        lastBuild:
          type: string
          format: date-time
        building:
          type: boolean
