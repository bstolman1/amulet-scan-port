name: Parallel Backfill

on:
  workflow_dispatch:
    inputs:
      migration_id:
        description: 'Migration ID to backfill'
        required: true
        type: number
      worker_count:
        description: 'Number of parallel workers'
        required: true
        type: number
        default: 8

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      synchronizers: ${{ steps.detect.outputs.synchronizers }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install dependencies
        run: npm install
        
      - name: Detect synchronizers
        id: detect
        run: |
          # This would call your script to get synchronizer list
          # For now, we'll create a matrix based on worker count
          WORKERS='[]'
          for i in $(seq 0 ${{ inputs.worker_count }}); do
            WORKERS=$(echo $WORKERS | jq ". += [{\"id\": $i}]")
          done
          echo "synchronizers=$WORKERS" >> $GITHUB_OUTPUT

  backfill:
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: ${{ inputs.worker_count }}
      matrix:
        worker: ${{ fromJson(needs.setup.outputs.synchronizers) }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install dependencies
        run: npm install
        
      - name: Run backfill worker ${{ matrix.worker.id }}
        env:
          BASE_URL: ${{ secrets.BASE_URL }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
          MIGRATION_ID: ${{ inputs.migration_id }}
          WORKER_ID: ${{ matrix.worker.id }}
          WORKER_COUNT: ${{ inputs.worker_count }}
        run: |
          echo "ðŸš€ Starting backfill worker ${{ matrix.worker.id }} of ${{ inputs.worker_count }}"
          node scripts/fetch-backfill-history.js
        timeout-minutes: 1440  # 24 hours max per worker

  verify:
    needs: backfill
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Verify backfill completion
        run: |
          echo "âœ… All backfill workers completed"
          echo "ðŸ“Š Next steps:"
          echo "  1. Run scripts/restore-after-backfill.sql to restore indexes"
          echo "  2. Monitor index creation progress"
          echo "  3. Run ANALYZE on tables"
